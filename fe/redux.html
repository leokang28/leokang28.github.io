<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redux源码阅读笔记 | KSLEO</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/assets/css/0.styles.35aebc44.css" as="style"><link rel="preload" href="/assets/js/app.6f46cf57.js" as="script"><link rel="preload" href="/assets/js/2.49ce1412.js" as="script"><link rel="preload" href="/assets/js/19.118b3a66.js" as="script"><link rel="prefetch" href="/assets/js/10.86ad4e85.js"><link rel="prefetch" href="/assets/js/11.e7ef91a0.js"><link rel="prefetch" href="/assets/js/12.14d347b9.js"><link rel="prefetch" href="/assets/js/13.beaf8085.js"><link rel="prefetch" href="/assets/js/14.e42e08a4.js"><link rel="prefetch" href="/assets/js/15.41e8c95f.js"><link rel="prefetch" href="/assets/js/16.e8b84c5d.js"><link rel="prefetch" href="/assets/js/17.4d574f20.js"><link rel="prefetch" href="/assets/js/18.a8a8e164.js"><link rel="prefetch" href="/assets/js/20.ccdc0717.js"><link rel="prefetch" href="/assets/js/21.88ceead5.js"><link rel="prefetch" href="/assets/js/22.500d3be7.js"><link rel="prefetch" href="/assets/js/23.b7ca339b.js"><link rel="prefetch" href="/assets/js/24.0360313a.js"><link rel="prefetch" href="/assets/js/25.6083b636.js"><link rel="prefetch" href="/assets/js/26.1bd9d3eb.js"><link rel="prefetch" href="/assets/js/27.beb716dd.js"><link rel="prefetch" href="/assets/js/28.bb093ca6.js"><link rel="prefetch" href="/assets/js/29.5b527549.js"><link rel="prefetch" href="/assets/js/3.8a6c11df.js"><link rel="prefetch" href="/assets/js/30.796276de.js"><link rel="prefetch" href="/assets/js/31.666b101e.js"><link rel="prefetch" href="/assets/js/32.654129d9.js"><link rel="prefetch" href="/assets/js/33.e479db51.js"><link rel="prefetch" href="/assets/js/4.e2a8d64a.js"><link rel="prefetch" href="/assets/js/5.dd4c966a.js"><link rel="prefetch" href="/assets/js/6.00a6c78e.js"><link rel="prefetch" href="/assets/js/7.9330d48e.js"><link rel="prefetch" href="/assets/js/8.560dd961.js"><link rel="prefetch" href="/assets/js/9.da6c1180.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35aebc44.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">KSLEO</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/directory/" class="nav-link">
  笔记📒
</a></div><div class="nav-item"><a href="http://leokang28.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客🔗
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/directory/" class="nav-link">
  笔记📒
</a></div><div class="nav-item"><a href="http://leokang28.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客🔗
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redux源码阅读笔记"><a href="#redux源码阅读笔记" class="header-anchor">#</a> Redux源码阅读笔记</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>之前对redux有一些简单的应用，并且大致理解redux的整体设计，出于深入了解的目的读一下源码。因此本文不设计任何redux的概念解释以及用法介绍，仅对源代码做一个逻辑整理。</p> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <p>Redux的目录结构和代码都比较简洁。目录结构如下</p> <div class="language- extra-class"><pre><code>/src
├── applyMiddleware.ts
├── bindActionCreators.ts
├── combineReducers.ts
├── compose.ts
├── createStore.ts
├── index.ts
├── types
│   ├── actions.ts
│   ├── middleware.ts
│   ├── reducers.ts
│   └── store.ts
└── utils
    ├── actionTypes.ts
    ├── isPlainObject.ts
    ├── symbol-observable.ts
    └── warning.ts
</code></pre></div><p>接着看一下rollup的配置文件，它配置了三种种模块输出：CommonJS、ES、UMD。rollup的使用不在这篇笔记的讨论范围内，这里主要用来查看一下入口文件在哪里。配置文件表明Redux的入口文件是<code>src/index.ts</code>。打开该文件看看里面的内容，发现它的主要作用是将其他文件中的模块进行整合然后统一导出。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// types</span>
<span class="token comment">// store</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  CombinedState<span class="token punctuation">,</span>
  PreloadedState<span class="token punctuation">,</span>
  Dispatch<span class="token punctuation">,</span>
  Unsubscribe<span class="token punctuation">,</span>
  Observable<span class="token punctuation">,</span>
  Observer<span class="token punctuation">,</span>
  Store<span class="token punctuation">,</span>
  StoreCreator<span class="token punctuation">,</span>
  StoreEnhancer<span class="token punctuation">,</span>
  StoreEnhancerStoreCreator<span class="token punctuation">,</span>
  ExtendState
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./types/store'</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>index.ts</code>的工作就是这些，整合并统一导出模块。</p> <p>平时使用Redux时我们应该知道，我们使用最多的API是<code>createStore</code>、<code>combineReducers</code>、<code>applyMiddlewares</code>等。接下来一一查看这些API的源码。</p> <h3 id="createstore"><a href="#createstore" class="header-anchor">#</a> <code>createStore</code></h3> <p><code>createStore</code>用来创建一个store实例。它的函数签名如下：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> createStore<span class="token operator">&lt;</span>
  <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token punctuation">,</span>
  Ext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  StateExt <span class="token operator">=</span> <span class="token builtin">never</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  enhancer<span class="token operator">?</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span>Ext<span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
<span class="token keyword">function</span> createStore<span class="token operator">&lt;</span>
  <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token punctuation">,</span>
  Ext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  StateExt <span class="token operator">=</span> <span class="token builtin">never</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  preloadedState<span class="token operator">?</span><span class="token operator">:</span> PreloadedState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  enhancer<span class="token operator">?</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span>Ext<span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
<span class="token keyword">function</span> createStore<span class="token operator">&lt;</span>
  <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token punctuation">,</span>
  Ext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  StateExt <span class="token operator">=</span> <span class="token builtin">never</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  preloadedState<span class="token operator">?</span><span class="token operator">:</span> PreloadedState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span> <span class="token operator">|</span> StoreEnhancer<span class="token operator">&lt;</span>Ext<span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  enhancer<span class="token operator">?</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span>Ext<span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>签名有些长，并且有重载定义。只拿出其中一个实现来看：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> createStore<span class="token operator">&lt;</span>
  <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">Action</span><span class="token punctuation">,</span>
  Ext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  StateExt <span class="token operator">=</span> <span class="token builtin">never</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  preloadedState<span class="token operator">?</span><span class="token operator">:</span> PreloadedState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  enhancer<span class="token operator">?</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span>Ext<span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>createStore</code>定义了四个范型变量，它们的含义分别是</p> <ul><li>S: 实例化的store存储的数据类型。</li> <li>A: 实例化的store未来将要dispatch的action类型。</li> <li>Ext: store enhancer返回的store扩展。</li> <li>StateExt: store enhancer返回的state扩展。</li></ul> <p>这个store enhancer可以理解为给store额外添加一些功能，这些功能有可能会改变dispatch和reducer的工作流程。比如为redux注册中间件，就是enhancer。总之是返回一个功能扩展版本的store实例。</p> <p><code>createStore</code>接收两个参数。</p> <ul><li>reducer: reducer函数。是一个纯函数，更新store的逻辑写在这个函数中。</li> <li>prelaodedState: 初始化的state。如果使用了<code>combineReducers</code>来生成<code>reducer</code>，那这个对象必须和<code>combineReducers</code>有一样的key。是可选参数</li> <li>enhancer: 对store的增强扩展，是可选参数。</li></ul> <p><code>createStore</code>返回一个<code>Store</code>和<code>Ext</code>的交叉类型。即我们最终得到的store实例的类型。</p> <h4 id="函数逻辑"><a href="#函数逻辑" class="header-anchor">#</a> 函数逻辑</h4> <p>函数开头是一些参数的安全性检查。其中这一段比较重要：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> enhancer <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Expected the enhancer to be a function.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>
      reducer<span class="token punctuation">,</span>
      preloadedState <span class="token keyword">as</span> PreloadedState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>检查<code>enhancer</code>参数的合法性，如果是一个合法的enhancer，则用它来生成最终的store实例。</p> <p>接下来是一些<code>store</code>实例方法的定义。</p> <h5 id="getstate"><a href="#getstate" class="header-anchor">#</a> <code>getState</code></h5> <p>返回当前的state数据。这个函数中做了一个条件判断，如果当前有正在进行的dispatch操作，则抛出一个错误。</p> <h5 id="subscribe"><a href="#subscribe" class="header-anchor">#</a> <code>subscribe</code></h5> <p>用来订阅store的更新。当dispatch时，订阅方会被告知。该函数返回一个方法，用于当前订阅方的订阅解除。</p> <h5 id="dispatch"><a href="#dispatch" class="header-anchor">#</a> <code>dispatch</code></h5> <p>最重要的方法之一<code>dispatch</code>在这里定义。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        isDispatching <span class="token operator">=</span> <span class="token boolean">true</span>
        currentState <span class="token operator">=</span> <span class="token function">currentReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        isDispatching <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> listeners <span class="token operator">=</span> <span class="token punctuation">(</span>currentListeners <span class="token operator">=</span> nextListeners<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 

    <span class="token keyword">return</span> action
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>首先将<code>isDispatching</code>标记为true，表示正在执行dispatch，其他操作都不可被执行，dispatch完毕后，再将其设置为false。接下来读取所有的listeners，并依次执行。最后将action返回。</p> <h5 id="replacereducer"><a href="#replacereducer" class="header-anchor">#</a> <code>replaceReducer</code></h5> <p>这个函数用来更新当前store实例的根reducer。</p> <h5 id="observable"><a href="#observable" class="header-anchor">#</a> <code>observable</code></h5> <p>可观测订阅方法的最简实现。用于监听store的变化，触发事件流。订阅者需要提供next方法才会订阅成功，可以看出是想通过一种类似于迭代器的功能实现订阅的自动发布。同时还使用到了Symbol对象上的observable属性。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> outerSubscribe <span class="token operator">=</span> subscribe <span class="token comment">// store实例方法上的subscribe</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">observer<span class="token operator">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> observer <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> observer <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Expected the observer to be an object.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">function</span> <span class="token function">observeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> observerAsObserver <span class="token operator">=</span> observer <span class="token keyword">as</span> Observer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>observerAsObserver<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observerAsObserver<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">observeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">outerSubscribe</span><span class="token punctuation">(</span>observeState<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> unsubscribe <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token punctuation">[</span>$$observable<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>最后，<code>createStore</code>方法dispatch一个<code>init action</code>，然后把这些属性组合，返回store实例，<code>createStore</code>执行结束。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> ActionTypes<span class="token punctuation">.</span><span class="token constant">INIT</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token constant">A</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        dispatch<span class="token operator">:</span> dispatch <span class="token keyword">as</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        subscribe<span class="token punctuation">,</span>
        getState<span class="token punctuation">,</span>
        replaceReducer<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>$$observable<span class="token punctuation">]</span><span class="token operator">:</span> observable
    <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Store<span class="token operator">&lt;</span>ExtendState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> StateExt<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">,</span> StateExt<span class="token punctuation">,</span> Ext<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Ext
<span class="token keyword">return</span> store
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="applymiddleware"><a href="#applymiddleware" class="header-anchor">#</a> <code>applyMiddleware</code></h3> <p>之前在<code>createStore</code>函数中，有一个enhancer参数检测的逻辑，它可以对store进行功能扩展，并且将store实例的生成移交给它处理。而作为redux来说，它只提供了一种enhancer——<code>applyMiddleware</code>。</p> <p>它的函数签名如下：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares<span class="token operator">:</span> Middleware<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接收一个中间件数组，返回一个enhancer函数。这个函数我们会传给<code>createStore</code>，然后进入<code>createStore</code>内部的enhancer逻辑。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6f46cf57.js" defer></script><script src="/assets/js/2.49ce1412.js" defer></script><script src="/assets/js/19.118b3a66.js" defer></script>
  </body>
</html>
